name: tests

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  FOUNDRY_PROFILE: ci

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    env:
      ALCHEMY_KEY: ${{ secrets.ALCHEMY_KEY }}
      PROXY: true
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Show Forge version
        run: forge --version

      - name: Run Soldeer install
        run: forge soldeer install

      - name: Compile smart contracts and tests
        run: forge build

      - name: Save build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: foundry-build
          path: |
            out/
            cache/

  # Mantle Tests (run in parallel with Mainnet tests)
  test-wmantle-mantle:
    needs: setup
    name: WBTC Mantle
    runs-on: ubuntu-latest
    env:
      FOUNDRY_ETH_RPC_URL: https://mantle-mainnet.g.alchemy.com/v2/${{ secrets.ALCHEMY_KEY }}
      WRAPPED_NATIVE_TOKEN: "0x4200000000000000000000000000000000000006"
      ASSET: "0x9c9F28672C4A8Ad5fb2c9Aca6d8D68B02EAfd552"
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Restore build artifacts
        uses: actions/download-artifact@v4
        with:
          name: foundry-build
          path: .
      - run: forge test -vvv
        env:
          PROXY: false
  # Mainnet Tests (run in parallel)
  # test-usdt-mainnet:
  #   needs: setup
  #   name: USDC Mainnet
  #   runs-on: ubuntu-latest
  #   env:
  #     FOUNDRY_ETH_RPC_URL: https://eth-mainnet.g.alchemy.com/v2/${{ secrets.ALCHEMY_KEY }}
  #     WRAPPED_NATIVE_TOKEN: "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2"
  #     UNDERLYING: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48"
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         submodules: recursive
  #     - uses: foundry-rs/foundry-toolchain@v1
  #     - run: forge clean && forge build && PROXY=true forge test -vvv
  #       env:
  #         PROXY: true

  # test-weth-mainnet:
  #   needs: setup
  #   name: WETH Mainnet
  #   runs-on: ubuntu-latest
  #   env:
  #     FOUNDRY_ETH_RPC_URL: https://eth-mainnet.g.alchemy.com/v2/${{ secrets.ALCHEMY_KEY }}
  #     WRAPPED_NATIVE_TOKEN: "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2"
  #     UNDERLYING: "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2"
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         submodules: recursive
  #     - uses: foundry-rs/foundry-toolchain@v1
  #     - run: forge clean && forge build && forge test -vvv
  #       env:
  #         PROXY: true
