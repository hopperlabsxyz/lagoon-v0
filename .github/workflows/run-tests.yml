name: tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

env:
  FOUNDRY_PROFILE: ci

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    env:
      ALCHEMY_KEY: ${{ secrets.ALCHEMY_KEY }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Show Forge version
        run: forge --version

      - name: Run Soldeer install
        run: forge soldeer install

      - name: Compile smart contracts
        run: forge build --force

      - name: Save build artifacts and install
        uses: actions/upload-artifact@v4
        with:
          name: foundry-install-build
          path: |
            out/
            cache/
            dependencies/

  # Mantle Tests (run in parallel with Mainnet tests)
  test-wbtc-mantle:
    needs: setup
    name: WBTC MANTLE
    runs-on: ubuntu-latest
    env:
      FOUNDRY_ETH_RPC_URL: https://mantle-mainnet.g.alchemy.com/v2/${{ secrets.ALCHEMY_KEY }}
      WRAPPED_NATIVE_TOKEN: "0x4200000000000000000000000000000000000006"
      ASSET: "0x9c9F28672C4A8Ad5fb2c9Aca6d8D68B02EAfd552"
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Restore build artifacts
        uses: actions/download-artifact@v4
        with:
          name: foundry-install-build
          path: .
      - run: forge test -vvv
        env:
          PROXY: false

  test-weth-mainnet:
    needs: setup
    name: WETH MAINNET
    runs-on: ubuntu-latest
    env:
      FOUNDRY_ETH_RPC_URL: https://eth-mainnet.g.alchemy.com/v2/${{ secrets.ALCHEMY_KEY }}
      WRAPPED_NATIVE_TOKEN: "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2"
      ASSET: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48"
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Restore build artifacts
        uses: actions/download-artifact@v4
        with:
          name: foundry-install-build
          path: .
      - run: forge test -vvv
        env:
          PROXY: false

  test-wtac-tac:
    needs: setup
    name: WTAC TAC
    runs-on: ubuntu-latest
    env:
      FOUNDRY_ETH_RPC_URL: https://rpc.ankr.com/tac
      WRAPPED_NATIVE_TOKEN: "0xB63B9f0eb4A6E6f191529D71d4D88cc8900Df2C9"
      ASSET: "0xB63B9f0eb4A6E6f191529D71d4D88cc8900Df2C9"
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Restore build artifacts
        uses: actions/download-artifact@v4
        with:
          name: foundry-install-build
          path: .
      - run: forge test -vvv
        env:
          PROXY: false

  test-usdc-bnb:
    needs: setup
    name: USDT WORMHOLE BNB
    runs-on: ubuntu-latest
    env:
      FOUNDRY_ETH_RPC_URL: https://bnb-mainnet.g.alchemy.com/v2/${{ secrets.ALCHEMY_KEY }}
      WRAPPED_NATIVE_TOKEN: "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c"
      ASSET: "0x524bC91Dc82d6b90EF29F76A3ECAaBAffFD490Bc"
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Restore build artifacts
        uses: actions/download-artifact@v4
        with:
          name: foundry-install-build
          path: .
      - run: forge test -vvv
        env:
          PROXY: false

  test-wbnb-bnb:
    needs: setup
    name: WBNB BNB
    runs-on: ubuntu-latest
    env:
      FOUNDRY_ETH_RPC_URL: https://bnb-mainnet.g.alchemy.com/v2/${{ secrets.ALCHEMY_KEY }}
      WRAPPED_NATIVE_TOKEN: "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c"
      ASSET: "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c"
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Restore build artifacts
        uses: actions/download-artifact@v4
        with:
          name: foundry-install-build
          path: .
      - run: forge test -vvv
        env:
          PROXY: false

  test-pbtc-botanix:
    needs: setup
    name: PBTC BOTANIX
    runs-on: ubuntu-latest
    env:
      FOUNDRY_ETH_RPC_URL: https://botanix-mainnet.g.alchemy.com/v2/${{ secrets.ALCHEMY_KEY }}
      WRAPPED_NATIVE_TOKEN: "0x0D2437F93Fed6EA64Ef01cCde385FB1263910C56"
      ASSET: "0x0D2437F93Fed6EA64Ef01cCde385FB1263910C56"
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Restore build artifacts
        uses: actions/download-artifact@v4
        with:
          name: foundry-install-build
          path: .
      - run: forge test -vvv
        env:
          PROXY: false

  test-bridged-usdc-botanix:
    needs: setup
    name: USDC BOTANIX
    runs-on: ubuntu-latest
    env:
      FOUNDRY_ETH_RPC_URL: https://botanix-mainnet.g.alchemy.com/v2/${{ secrets.ALCHEMY_KEY }}
      WRAPPED_NATIVE_TOKEN: "0x0D2437F93Fed6EA64Ef01cCde385FB1263910C56"
      ASSET: "0x29eE6138DD4C9815f46D34a4A1ed48F46758A402"
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Restore build artifacts
        uses: actions/download-artifact@v4
        with:
          name: foundry-install-build
          path: .
      - run: forge test -vvv
        env:
          PROXY: false
  test-whype-hyperevm:
    needs: setup
    name: WHYPE HYPEREVM
    runs-on: ubuntu-latest
    env:
      FOUNDRY_ETH_RPC_URL: https://hyperliquid-mainnet.g.alchemy.com/v2/${{ secrets.ALCHEMY_KEY }}
      WRAPPED_NATIVE_TOKEN: "0x5555555555555555555555555555555555555555"
      ASSET: "0x5555555555555555555555555555555555555555"
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Restore build artifacts
        uses: actions/download-artifact@v4
        with:
          name: foundry-install-build
          path: .
      - run: forge test -vvv
        env:
          PROXY: false

  test-rusdc-hyperevm:
    needs: setup
    name: rUSDC HYPEREVM
    runs-on: ubuntu-latest
    env:
      FOUNDRY_ETH_RPC_URL: https://hyperliquid-mainnet.g.alchemy.com/v2/${{ secrets.ALCHEMY_KEY }}
      WRAPPED_NATIVE_TOKEN: "0x5555555555555555555555555555555555555555"
      ASSET: "0x9ab96A4668456896d45c301Bc3A15Cee76AA7B8D"
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Restore build artifacts
        uses: actions/download-artifact@v4
        with:
          name: foundry-install-build
          path: .
      - run: forge test -vvv
        env:
          PROXY: false
